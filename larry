<?php

function autoload($classname)
{
    $parts = explode('\\', $classname);
    include dirname(__FILE__) . '/classes/' . end($parts) . '.php';
}
spl_autoload_register('autoload');

if (count($argv) <= 2)
{
    echo "Usage: php larry <input_filename> <output_dirname>";
    exit();
}

$inputFilename = $argv[1];
$outputDirname = $argv[2];

$parser = new Larry\Parser($inputFilename);
$models = $parser->getModels();
$relationalModels = $parser->getRelationModels();

// Create directories
mkdir($outputDirname);
mkdir($outputDirname . '/migrations');
mkdir($outputDirname . '/models');

// Write model migrations
foreach ($models as $model)
{
    $migration = new Larry\MigrationGenerator($model);
    file_put_contents(
        $outputDirname . '/migrations/' . $migration->getFilename(),
        $migration->getOutput()
    );

    echo "[MIGRATION WRITTEN] " . $migration->getFilename() . "\n";
}

// Write relation model migrations
foreach ($relationalModels as $model)
{
    $migration = new Larry\MigrationGenerator($model);
    file_put_contents(
        $outputDirname . '/migrations/' . $migration->getFilename(),
        $migration->getOutput()
    );

    echo "[MIGRATION WRITTEN] " . $migration->getFilename() . "\n";
}

// Write model files
foreach ($models as $model)
{
    $modelGenerator = new Larry\ModelGenerator($model);
    file_put_contents(
        $outputDirname . '/models/' . $modelGenerator->getFilename(),
        $modelGenerator->getOutput()
    );

    echo "[MODEL WRITTEN] " . $modelGenerator->getFilename() . "\n";
}

// Copy Basemodel
$baseModelContents = file_get_contents('templates/Basemodel.template');
file_put_contents(
    $outputDirname . '/models/Basemodel.php',
    $baseModelContents
);

echo "Process successfully completed.\n\n";